- name: Ensure gnu stow is installed
  package:
    name: stow
    state: present
  become: true

- name: Find all files in dotfiles directory
  find:
    paths: "{{ playbook_dir }}/dotfiles"
    file_type: any
    hidden: true
  register: dotfiles_list

- name: List files that will be deleted
  debug:
    msg: "The following files and directories will be deleted: {{ item.path | regex_replace('^' + playbook_dir + '/dotfiles', '~') }}"
  loop: "{{ dotfiles_list.files }}"
  tags: dotfiles

- name: Confirm deletion
  pause:
    prompt: "Are you sure you want to delete these files? (y/n)"
  register: confirm_deletion
  tags: dotfiles

- name: Delete dotfiles from home directory
  file:
    path: "{{ item.path | regex_replace('^' + playbook_dir + '/dotfiles', '~') }}"
    state: absent
  loop: "{{ dotfiles_list.files }}"
  when: confirm_deletion.user_input | lower in ['yes', 'y']
  tags: dotfiles

- name: Pause before stowing
  pause:
    seconds: 10
  when: confirm_deletion.user_input | lower in ['yes', 'y']
  tags: dotfiles

- name: stow all dotfiles to home directory (override)
  shell: stow --override='.*' -t ~ .
  args:
    chdir: "{{ playbook_dir }}/dotfiles"
  when: confirm_deletion.user_input | lower in ['yes', 'y']
